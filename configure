#!/bin/bash

dots=$(pwd)/dots

#=== FUNCTION =================================================================
#        NAME: backup
# DESCRIPTION: backup a file ($1 => $1.bak) if it exists
# PARAMETER 1: the file you want to backup
#==============================================================================
backup() {
    local fname=$1
    [ -e "$fname" ] && mv "$fname" "$fname.bak"
}

#=== FUNCTION =================================================================
#        NAME: link
# DESCRIPTION: create a symbolic link
# PARAMETER 1: the file you want to end up pointing to
# PARAMETER 2: the configuration file from this repo
#==============================================================================
link() {
    local dest=$1
    local src=$2

    backup "$dest"
    [ -h "$dest" ] && rm "$dest"

    echo "linking $src with $dest"
    ln -s "$src" "$dest"
}

#=== FUNCTION =================================================================
#        NAME: usage
# DESCRIPTION: prints help output
#==============================================================================
usage() {
    echo "USAGE: ./configuration <flag|tool>"
    echo
    echo "  Flags:"
    echo "  --help: view this help text"
    echo "  --update: update dependencies (like Vim plugins)"
    echo
    echo "  Tools:"

    for option in git vim ctags tmux screen bash
    do
        echo "  * $option"
    done
}

#=== MAIN =====================================================================
if [ -z "$1" ]; then
  usage
  exit 1
fi

for arg in "$@"
do
    case $arg in
        git)
            link ~/.gitconfig "$dots/gitconfig"
            link ~/.gitignore "$dots/gitignore"
            ;;

        vim)
            git submodule update --init
            link ~/.vimrc "$dots/vimrc"
            link ~/.vim "$dots/vim"
            ;;

        ctags)
            link ~/.ctags "$dots/ctags"
            ;;

        tmux)
            link ~/.tmux.conf "$dots/tmux.conf"
            ;;

        screen)
            link ~/.screenrc "$dots/screenrc"
            ;;

        bash)
            link ~/.bashrc "$dots/bashrc"
            ;;

        -u|--update)
            for p in dots/vim/bundle/*;
            do
              pushd "$p" &> /dev/null
              echo "updating $p..."
              git pull --rebase origin master &> /dev/null &
              popd &> /dev/null
            done

            wait
            echo "done updating $(echo $(wc -w <<< "$(ls ./dots/vim/bundle/)")) packages"

            ;;

        -h|--help)
            usage
            ;;

        *)
            echo "Invalid argument $arg"
            echo
            usage
            exit 1
            ;;
    esac
done
